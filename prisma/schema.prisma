generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum OrderItemStatus {
  PENDING // default state after creation
  CANCEL_REQUESTED // user requested cancellation
  APPROVED // admin approved (e.g., to proceed/ship)
  CANCELLED // admin cancelled this item
}

enum PaymentMethod {
  UPI
  COD
  CARD
  NETBANKING
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// ─── BRAND ─────────────────────────────────────────────────────────────────────

model Brand {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  logo_url   String?
  status     Boolean  @default(true)
  created_at DateTime @default(now())

  products Product[]

  // Back-relation for MainProductPromotion
  mainProductPromotions MainProductPromotion[] @relation("MPP_Brand")

  @@map("brands")
}

// ─── COLOR & SIZE ─────────────────────────────────────────────────────────────

model Color {
  id       Int     @id @default(autoincrement())
  label    String
  hex_code String?
  status   Boolean @default(true)

  // two separate relations need distinct names:
  products Product[] @relation("ProductMainColor")
  variants Variant[] @relation("VariantColor")

  @@map("colors")
}

model SizeUOM {
  id     Int     @id @default(autoincrement())
  title  String  @unique
  status Boolean @default(true)

  variants Variant[] @relation("VariantSizeRelation")
  products Product[] @relation("ProductSizeRelation")

  @@map("size_uom")
}

// ─── VARIANT ──────────────────────────────────────────────────────────────────

model Variant {
  id           Int    @id @default(autoincrement())
  productId    Int
  sku          String
  stock        Int
  mrp          Float
  sellingPrice Float
  sizeId       Int?
  colorId      Int?

  product   Product     @relation(fields: [productId], references: [id])
  size      SizeUOM?    @relation("VariantSizeRelation", fields: [sizeId], references: [id])
  color     Color?      @relation("VariantColor", fields: [colorId], references: [id])
  images    Image[]
  OrderItem OrderItem[]
  Wishlist  Wishlist[]
  CartItem  CartItem[]

  // NEW: back-relation to Buy Now items
  buyNowItems BuyNowItem[]

  @@map("product_variants")
}

// ─── PRODUCT DETAILS & IMAGES ─────────────────────────────────────────────────

model ProductDetails {
  id              Int     @id @default(autoincrement())
  productId       Int     @unique
  model           String?
  weight          Float?
  sla             Int?
  deliveryCharges Float?

  product Product @relation(fields: [productId], references: [id])

  @@map("product_details")
}

model Image {
  id        Int     @id @default(autoincrement())
  productId Int?
  variantId Int?
  url       String
  alt       String?
  isMain    Boolean @default(false)

  product Product? @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])

  @@map("product_images")
}

// ─── MISCELLANEOUS MODELS ──────────────────────────────────────────────────────

model Warranty {
  id              Int     @id @default(autoincrement())
  duration_months Int?
  description     String?

  @@map("warranties")
}

model Style {
  id     Int     @id @default(autoincrement())
  name   String
  status Boolean @default(true)

  @@map("styles")
}

model Finish {
  id     Int     @id @default(autoincrement())
  name   String
  status Boolean @default(true)

  @@map("finishes")
}

model Material {
  id     Int     @id @default(autoincrement())
  name   String
  status Boolean @default(true)

  @@map("materials")
}

model ShippingPartner {
  id            Int     @id @default(autoincrement())
  name          String?
  api_key       String?
  contact_email String?
  status        Boolean @default(true)

  @@map("shipping_partners")
}

model TaxRule {
  id            Int          @id @default(autoincrement())
  name          String?
  percentage    Float?
  applicable_on ApplicableOn @default(MRP)

  @@map("tax_rules")
}

enum ApplicableOn {
  MRP
  Discounted
}

model Vendor {
  id            Int     @id @default(autoincrement())
  name          String
  contact_email String?
  phone         String?
  address       String?
  status        Boolean @default(true)

  @@map("vendors")
}

model Slider {
  id         Int      @id @default(autoincrement())
  title      String
  image_url  String
  link       String?
  priority   Int      @default(0)
  status     Boolean  @default(true)
  created_at DateTime @default(now())

  @@map("sliders")
}

model SliderRight {
  id        Int      @id @default(1)
  image1    String
  image2    String
  image3    String
  updatedAt DateTime @updatedAt

  @@map("slider_right")
}

// ─── MAIN CATEGORY PROMOTIONS (camelCase fields, mapped to snake_case) ───
model MainCategoryPromotion {
  id           Int     @id @default(autoincrement())
  title        String
  displayCount Int
  priority     Int
  imageUrl     String?
  status       Boolean @default(true)
  showTitle    Boolean @default(true) // ✅ new field

  createdAt DateTime @default(now())

  // Back-reference
  mainProductPromotions        MainProductPromotion[]
  ProductMainCategoryPromotion ProductMainCategoryPromotion[]

  @@map("main_category_promotions")
}

// ─── MAIN PRODUCT PROMOTIONS (updated) ─────────────────────────────────────
model MainProductPromotion {
  id       Int    @id @default(autoincrement())
  title    String
  priority Int    @default(0)

  // CHANGED: replace string "displayPosition" with an FK
  mainCategoryPromotionId Int
  mainCategoryPromotion   MainCategoryPromotion @relation(fields: [mainCategoryPromotionId], references: [id])

  imageUrl String

  // Targeting (align with Product: categoryId = List Sub Menu)
  categoryId       Int
  brandId          Int?
  seller           String?
  minPrice         Float?
  maxPrice         Float?
  offerPercentFrom Float?
  offerPercentTo   Float?

  // SEO
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?

  // Lifecycle
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products ProductMainCategoryPromotion[]

  category Category @relation("MPP_Category", fields: [categoryId], references: [id])
  brand    Brand?   @relation("MPP_Brand", fields: [brandId], references: [id])

  @@index([mainCategoryPromotionId])
  @@map("main_product_promotions")
}

model ProductMainCategoryPromotion {
  productId               Int
  mainCategoryPromotionId Int
  createdAt               DateTime @default(now())

  product                Product               @relation(fields: [productId], references: [id])
  mainCategoryPromotion  MainCategoryPromotion @relation(fields: [mainCategoryPromotionId], references: [id])
  MainProductPromotion   MainProductPromotion? @relation(fields: [mainProductPromotionId], references: [id])
  mainProductPromotionId Int?

  @@id([productId, mainCategoryPromotionId])
  @@map("product_main_category_promotions")
}

model AssemblyType {
  id   Int    @id @default(autoincrement())
  name String

  @@map("assembly_types")
}

// ─── CATEGORY & PRODUCT ────────────────────────────────────────────────────────

model Category {
  id                   Int        @id @default(autoincrement())
  title                String
  position             Int?
  status               Boolean    @default(true)
  frontDisplay         String?
  appIcon              String?
  webImage             String?
  mainImage            String?
  parentId             Int?
  showInNeedHelpBuying Boolean    @default(false)
  showInHomeTabs       Boolean    @default(false)
  parent               Category?  @relation("CategoryToChildren", fields: [parentId], references: [id])
  children             Category[] @relation("CategoryToChildren")

  // direct one‑to‑one to FeatureType and FilterType
  featureTypeId Int?
  featureType   FeatureType? @relation(fields: [featureTypeId], references: [id])
  filterTypeId  Int?
  filterType    FilterType?  @relation(fields: [filterTypeId], references: [id])

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Back-relation for MainProductPromotion (single categoryId like Product)
  mainProductPromotions MainProductPromotion[] @relation("MPP_Category")
  FeaturedCategory      FeaturedCategory[]

  @@map("categories")
}

model Product {
  id          Int     @id @default(autoincrement())
  sku         String  @unique
  title       String
  description String?

  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  colorId Int?
  color   Color? @relation("ProductMainColor", fields: [colorId], references: [id])

  sizeId Int?
  size   SizeUOM? @relation("ProductSizeRelation", fields: [sizeId], references: [id])

  mrp            Float
  sellingPrice   Float
  stock          Int
  searchKeywords String?

  variants       Variant[]
  images         Image[]
  productDetails ProductDetails?
  features       ProductFeature[]
  filters        ProductFilter[]

  status                 Boolean                        @default(true)
  createdAt              DateTime                       @default(now())
  updatedAt              DateTime                       @updatedAt
  OrderItem              OrderItem[]
  Wishlist               Wishlist[]
  CartItem               CartItem[]
  mainCategoryPromotions ProductMainCategoryPromotion[]

  // NEW: back-relation to Buy Now items
  buyNowItems BuyNowItem[]

  @@map("products")
}

// ─── FEATURE HIERARCHY & JOINS ────────────────────────────────────────────────

model FeatureType {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  featureSets FeatureSet[]
  Category    Category[]

  @@map("feature_types")
}

model FeatureSet {
  id            Int           @id @default(autoincrement())
  title         String
  priority      Int           @default(0)
  status        Boolean       @default(true)
  featureTypeId Int
  featureType   FeatureType   @relation(fields: [featureTypeId], references: [id])
  featureLists  FeatureList[]

  @@map("feature_sets")
}

model FeatureList {
  id           Int        @id @default(autoincrement())
  label        String
  priority     Int        @default(0)
  status       Boolean    @default(true)
  featureSetId Int
  featureSet   FeatureSet @relation(fields: [featureSetId], references: [id])

  productFeatures ProductFeature[]

  @@map("feature_lists")
}

model ProductFeature {
  id            Int     @id @default(autoincrement())
  productId     Int
  featureListId Int
  value         String?

  product     Product     @relation(fields: [productId], references: [id])
  featureList FeatureList @relation(fields: [featureListId], references: [id])

  @@unique([productId, featureListId], name: "productId_featureListId") // 
  @@map("product_features")
}

// ─── FILTER HIERARCHY & JOINS ─────────────────────────────────────────────────

model FilterType {
  id         Int         @id @default(autoincrement())
  name       String      @unique
  filterSets FilterSet[]
  Category   Category[]

  @@map("filter_types")
}

model FilterSet {
  id           Int          @id @default(autoincrement())
  title        String
  priority     Int          @default(0)
  status       Boolean      @default(true)
  filterTypeId Int
  filterType   FilterType   @relation(fields: [filterTypeId], references: [id])
  filterLists  FilterList[]

  @@map("filter_sets")
}

model FilterList {
  id          Int       @id @default(autoincrement())
  label       String
  priority    Int       @default(0)
  status      Boolean   @default(true)
  filterSetId Int
  filterSet   FilterSet @relation(fields: [filterSetId], references: [id])

  productFilters ProductFilter[]

  @@map("filter_lists")
}

model ProductFilter {
  id           Int @id @default(autoincrement())
  productId    Int
  filterListId Int

  product    Product    @relation(fields: [productId], references: [id])
  filterList FilterList @relation(fields: [filterListId], references: [id])

  @@unique([productId, filterListId], name: "productId_filterListId") // 
  @@map("product_filters")
}

enum Gender {
  Male
  Female
  Other
}

model User {
  id             Int      @id @default(autoincrement())
  name           String?
  email          String?
  password       String? @db.VarChar(255)
  phone          String   @unique
  role           UserRole @default(CUSTOMER)
  token          String?
  profilePicture String?

  alternateMobile String?
  gender          Gender?
  dateOfBirth     DateTime?

  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders         Order[]
  addresses      Address[]
  appliedCoupons AppliedCoupon[]
  Wishlist       Wishlist[]
  CartItem       CartItem[]

  // NEW: one-to-one Buy Now item
  buyNowItem BuyNowItem?

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
  VENDOR
  SUPPORT
}

model Address {
  id           Int     @id @default(autoincrement())
  userId       Int
  name         String
  buildingName String
  flatNumber   String
  addressLine1 String
  addressLine2 String
  city         String
  state        String
  pincode      String
  phone        String
  label        String // Home | Office | Other
  default      Boolean @default(false) //  Add this line

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]

  @@map("user_addresses")
}

model Order {
  id            Int           @id @default(autoincrement())
  userId        Int
  addressId     Int
  paymentMethod PaymentMethod
  couponId      Int?
  couponDiscount Float        @default(0)
  status        OrderStatus   @default(PENDING)
  subtotal      Float
  shippingFee   Float
  gst           Float
  totalAmount   Float
  note          String?
  orderFrom     String        @default("web") // NEW FIELD
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  coupon  Coupon?     @relation(fields: [couponId], references: [id])
  items   OrderItem[]
  payment Payment?

  @@map("orders")
}

model DeliveryOption {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  fee         Float
  days        String
}

model OrderItem {
  id        Int   @id @default(autoincrement())
  orderId   Int
  productId Int?
  variantId Int?
  quantity  Int   @default(1)
  price     Float // per item price
  total     Float // price * quantity

  // ⬇️ NEW moderation fields
  status         OrderItemStatus @default(PENDING)
  moderationNote String?

  order   Order    @relation(fields: [orderId], references: [id])
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant Variant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Payment {
  id            Int           @id @default(autoincrement())
  orderId       Int           @unique
  method        PaymentMethod
  status        PaymentStatus
  paidAt        DateTime?
  transactionId String?

  order Order @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model PriceRange {
  id    Int    @id @default(autoincrement())
  label String @unique // e.g., "100-500"
  min   Int
  max   Int? // nullable for "5000+"

  coupons Coupon[]
}

model Coupon {
  id             Int        @id @default(autoincrement())
  code           String     @unique
  type           CouponType
  priceType      PriceType
  value          Float
  minOrderAmount Float      @default(0)
  fromDate       DateTime?
  toDate         DateTime?
  status         Boolean    @default(true) //  New status field

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Dynamic condition fields based on coupon type
  menuId         Int?
  subMenuId      Int?
  listSubMenuId  Int?
  brandId        Int?
  sellerId       Int?
  url            String?
  priceRangeId   Int? // renamed from priceId
  priceRange     PriceRange?     @relation(fields: [priceRangeId], references: [id])
  appliedCoupons AppliedCoupon[]
  orders         Order[]

  @@map("coupons")
}

enum CouponType {
  LIST_SUBMENU
  BRAND
  URL
  PRICE
  SELLER
}

enum PriceType {
  FIXED
  PERCENTAGE
}

model AppliedCoupon {
  id        Int      @id @default(autoincrement())
  userId    Int
  couponId  Int
  orderId   Int?
  appliedAt DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, couponId]) // prevent reuse unless reset
  @@map("applied_coupons")
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  variantId Int?
  size      String?
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id])
  product Product  @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId])
  @@map("wishlist")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  variantId Int? //  Now optional
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  product Product  @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId]) //  Optional variant-safe unique constraint
  @@map("cart_items")
}

model ServiceableArea {
  id              Int     @id @default(autoincrement())
  pincode         String  @unique @db.VarChar(6)
  city            String
  state           String
  isActive        Boolean @default(true)
  codAvailable    Boolean @default(false)
  deliveryEtaDays Int?
  lastMileFee     Int? // in your currency (e.g., INR)

  @@index([pincode])
}

model BuyNowItem {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  productId Int
  variantId Int?
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  product Product  @relation(fields: [productId], references: [id])
  variant Variant? @relation(fields: [variantId], references: [id])

  @@map("buy_now_items")
}

model Contact {
  id          Int      @id @default(autoincrement())
  name        String
  email       String
  mobile      String?  @db.VarChar(20)
  subject     String?  @db.VarChar(255)
  description String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("contacts")
}

model UserSubscribe {
  id            Int      @id @default(autoincrement())
  email         String   @db.VarChar(180)
  subscribed_at DateTime @default(now())

  @@map("user_subscribers")
}

model Keyword {
  id        Int      @id @default(autoincrement())
  keyword   String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // optional but recommended

  @@index([createdAt])
  @@map("keywords") // keeps the existing table name
}

// Category already exists; ensure it’s hierarchical via parentId.
// Second-level means: category.parentId != null AND parent.parentId == null

model FeaturedCategory {
  id            Int       @id @default(autoincrement())
  categoryId    Int
  room          RoomType // which top tab/section (LivingRoom, Kitchen, Office, etc.)
  position      Int // 1..N ordering within that room
  status      Boolean   @default(true)
  titleOverride String? // optional: card title override
  imageOverride String? // optional: custom image for the card
  startsAt      DateTime? // optional scheduling window
  endsAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  category Category @relation(fields: [categoryId], references: [id])

  // one category can appear once per room
  @@unique([room, categoryId])
  // prevent two cards fighting for the same slot while active (soft rule, but helpful)
  @@index([room, position])
}

enum RoomType {
  LivingRoom
  Kitchen
  Office
  Study
  Garden
}
